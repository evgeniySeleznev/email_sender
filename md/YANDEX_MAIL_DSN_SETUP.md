# Настройка Яндекс.Почты для работы DSN (Delivery Status Notification)

## Обзор

Для работы механизма получения уведомлений о доставке email (DSN) через Яндекс.Почту необходимо выполнить несколько настроек в почтовом ящике. DSN уведомления будут приходить на тот же почтовый ящик, с которого отправляются письма, и их нужно читать через POP3.

## 1. Включение доступа через POP3

### Шаг 1: Вход в настройки Яндекс.Почты

1. Войдите в свой аккаунт Яндекс.Почты: https://mail.yandex.ru
2. Нажмите на иконку шестеренки (⚙️) в правом верхнем углу
3. Выберите **"Все настройки"**

### Шаг 2: Разрешение доступа через почтовые программы

1. В меню слева выберите раздел **"Почтовые программы"**
2. Найдите раздел **"Доступ по протоколу POP3"**
3. Включите переключатель **"Разрешить доступ к почтовому ящику с помощью почтовых клиентов"**
4. Выберите один из вариантов:
   - **"Оставлять копии писем на сервере"** - рекомендуется для DSN (уведомления будут сохраняться)
   - **"Удалять письма с сервера"** - не рекомендуется, так как уведомления будут удаляться после чтения

### Шаг 3: Сохранение настроек

1. Нажмите кнопку **"Сохранить изменения"**
2. Дождитесь подтверждения сохранения

## 2. Создание пароля приложения

⚠️ **ВАЖНО**: Яндекс требует использовать специальный пароль приложения для доступа через POP3/SMTP, а не основной пароль аккаунта.

### Шаг 1: Переход в настройки безопасности

1. Перейдите на страницу: https://id.yandex.ru/security
2. Или через меню Яндекс.Почты: **Настройки** → **Безопасность**

### Шаг 2: Создание пароля приложения

1. Найдите раздел **"Пароли приложений"**
2. Нажмите **"Создать новый пароль"**
3. Введите название приложения (например: "Email Service DSN")
4. Нажмите **"Создать"**
5. **Скопируйте и сохраните** сгенерированный пароль (он показывается только один раз!)

### Шаг 3: Использование пароля приложения

Используйте этот пароль в конфигурации вашего сервиса вместо основного пароля аккаунта:

```go
SMTPConfig{
    SMTPUser:     "your-email@yandex.ru",
    SMTPPassword: "пароль_приложения_из_шага_2", // НЕ основной пароль!
    POPHost:      "pop.yandex.ru",
    POPPort:      995, // SSL
    // ...
}
```

## 3. Настройки SMTP для отправки

### Параметры SMTP Яндекс.Почты

```
SMTP сервер: smtp.yandex.ru
SMTP порт: 465 (SSL) или 587 (STARTTLS)
Логин: ваш_email@yandex.ru
Пароль: пароль приложения (из шага 2)
```

### Включение SMTP доступа

1. В настройках Яндекс.Почты → **"Почтовые программы"**
2. Убедитесь, что включен **"Доступ по протоколу SMTP"**
3. Сохраните изменения

## 4. Настройки POP3 для получения DSN

### Параметры POP3 Яндекс.Почты

```
POP3 сервер: pop.yandex.ru
POP3 порт: 995 (SSL/TLS)
Логин: ваш_email@yandex.ru
Пароль: пароль приложения (из шага 2)
```

### Важные настройки POP3

1. **SSL/TLS обязателен** - используйте порт 995
2. **Оставлять копии на сервере** - чтобы не потерять уведомления
3. **Периодическая очистка** - настройте удаление старых DSN уведомлений (старше 30 дней)

## 5. Проверка работы DSN

### Тест 1: Проверка POP3 доступа

Используйте тестовый скрипт для проверки POP3:

```go
package main

import (
    "fmt"
    "github.com/emersion/go-pop3"
)

func main() {
    client, err := pop3.DialTLS("pop.yandex.ru:995", nil)
    if err != nil {
        fmt.Printf("Ошибка подключения: %v\n", err)
        return
    }
    defer client.Quit()
    
    auth := pop3.PlainAuth("", "your-email@yandex.ru", "app-password", "")
    if err := client.Auth(auth); err != nil {
        fmt.Printf("Ошибка аутентификации: %v\n", err)
        return
    }
    
    total, _, err := client.Stat()
    if err != nil {
        fmt.Printf("Ошибка получения статистики: %v\n", err)
        return
    }
    
    fmt.Printf("Успешно подключено! Сообщений в ящике: %d\n", total)
}
```

### Тест 2: Отправка тестового письма с DSN

Отправьте тестовое письмо с запросом DSN и проверьте, приходит ли уведомление в почтовый ящик.

## 6. Ограничения и особенности Яндекс.Почты

### Ограничения

1. **Лимит отправки**: 
   - Для бесплатных аккаунтов: до 500 писем в день
   - Для корпоративных аккаунтов: до 2000 писем в день

2. **Лимит POP3 подключений**:
   - Не более 10 одновременных подключений
   - Рекомендуется использовать пул подключений

3. **DSN поддержка**:
   - Яндекс.Почта поддерживает DSN уведомления
   - Уведомления приходят в течение нескольких минут после доставки/ошибки

### Особенности

1. **Фильтрация спама**: 
   - DSN уведомления могут попадать в спам
   - Рекомендуется создать правило для автоматической пересылки DSN в отдельную папку

2. **Формат уведомлений**:
   - Яндекс отправляет DSN в стандартном формате RFC 3464
   - Уведомления содержат `multipart/report` с типом `delivery-status`

3. **Envelope-Id**:
   - Яндекс сохраняет заголовок `X-Envelope-Id` в DSN уведомлениях
   - Это позволяет идентифицировать исходное сообщение

## 7. Настройка правил фильтрации (опционально)

### Создание правила для DSN уведомлений

1. В настройках Яндекс.Почты → **"Правила обработки почты"**
2. Нажмите **"Создать правило"**
3. Условие: **"Тема содержит"** → `"Delivery Status Notification"` или `"DSN"`
4. Действие: **"Переместить в папку"** → создайте папку "DSN Notifications"
5. Сохраните правило

Это поможет:
- Отделить DSN уведомления от обычной почты
- Упростить обработку уведомлений
- Избежать случайного удаления важных уведомлений

## 8. Конфигурация для Go проекта

### Пример конфигурации

```go
package emailservice

// SMTPConfig для Яндекс.Почты
var yandexConfig = &SMTPConfig{
    // SMTP настройки
    SMTPHost:       "smtp.yandex.ru",
    SMTPPort:       465, // или 587 для STARTTLS
    SMTPUser:       "your-service@yandex.ru",
    SMTPPassword:   "пароль_приложения", // НЕ основной пароль!
    SMTPDisplayName: "Your Service Name",
    
    // POP3 настройки для получения DSN
    POPHost:        "pop.yandex.ru",
    POPPort:        995, // SSL обязателен
    
    // Интервалы
    SMTPMinSendIntervalMsec:        1000,  // 1 секунда между отправками
    SMTPMinSendEmailIntervalMsec:   5000,  // 5 секунд между письмами на один адрес
    
    // DSN будет определен автоматически при подключении
    DSNEnabled: false, // Установится в true при подключении, если POPHost настроен
}
```

### Инициализация с SSL

```go
import (
    "crypto/tls"
    "github.com/emersion/go-pop3"
)

// Подключение к POP3 с SSL
func connectPOP3(config *SMTPConfig) (*pop3.Client, error) {
    tlsConfig := &tls.Config{
        ServerName: config.POPHost,
        // Для тестов можно использовать InsecureSkipVerify: true
        // В production используйте валидные сертификаты
    }
    
    client, err := pop3.DialTLS(fmt.Sprintf("%s:%d", config.POPHost, config.POPPort), tlsConfig)
    if err != nil {
        return nil, fmt.Errorf("ошибка подключения к POP3: %w", err)
    }
    
    auth := pop3.PlainAuth("", config.SMTPUser, config.SMTPPassword, config.POPHost)
    if err := client.Auth(auth); err != nil {
        client.Quit()
        return nil, fmt.Errorf("ошибка аутентификации POP3: %w", err)
    }
    
    return client, nil
}
```

## 9. Решение проблем

### Проблема: Не удается подключиться к POP3

**Решение:**
1. Проверьте, что POP3 доступ включен в настройках
2. Убедитесь, что используете пароль приложения, а не основной пароль
3. Проверьте, что используете порт 995 с SSL
4. Проверьте файрвол и сетевые настройки

### Проблема: DSN уведомления не приходят

**Решение:**
1. Проверьте, что при отправке запрашиваются DSN (заголовки `Return-Receipt-To`, `Disposition-Notification-To`)
2. Убедитесь, что `Envelope-Id` правильно формируется
3. Проверьте папку "Спам" - уведомления могут попадать туда
4. Проверьте, что получатель поддерживает DSN (не все почтовые сервисы поддерживают)

### Проблема: Ошибка аутентификации

**Решение:**
1. Убедитесь, что используете пароль приложения
2. Проверьте правильность логина (полный email адрес)
3. Убедитесь, что двухфакторная аутентификация включена (требуется для паролей приложений)

### Проблема: Превышен лимит отправки

**Решение:**
1. Уменьшите частоту отправки
2. Используйте несколько аккаунтов для рассылки
3. Рассмотрите переход на корпоративный аккаунт Яндекс.Почты

## 10. Безопасность

### Рекомендации

1. **Пароль приложения**:
   - Храните пароль приложения в безопасном месте (переменные окружения, секреты)
   - Не коммитьте пароли в репозиторий
   - Регулярно обновляйте пароли приложений

2. **SSL/TLS**:
   - Всегда используйте SSL для POP3 (порт 995)
   - Используйте SSL для SMTP (порт 465) или STARTTLS (порт 587)
   - Проверяйте сертификаты сервера

3. **Ограничение доступа**:
   - Используйте отдельный почтовый ящик только для сервиса
   - Не используйте личный почтовый ящик
   - Настройте правила фильтрации для защиты от спама

## 11. Альтернативные варианты

### Если Яндекс.Почта не подходит

1. **Корпоративная почта Яндекс**:
   - Больше лимитов на отправку
   - Лучшая поддержка DSN
   - Дополнительные возможности

2. **Другие почтовые сервисы**:
   - Gmail (требует OAuth2)
   - Mail.ru (аналогичные настройки)
   - Собственный почтовый сервер

3. **Специализированные сервисы**:
   - SendGrid
   - Mailgun
   - Amazon SES
   - (имеют встроенную поддержку webhook для статусов доставки)

## 12. Чек-лист настройки

- [ ] POP3 доступ включен в настройках Яндекс.Почты
- [ ] SMTP доступ включен в настройках Яндекс.Почты
- [ ] Создан пароль приложения
- [ ] Пароль приложения сохранен в безопасном месте
- [ ] Настроена конфигурация SMTP (smtp.yandex.ru:465)
- [ ] Настроена конфигурация POP3 (pop.yandex.ru:995)
- [ ] Протестировано подключение к POP3
- [ ] Протестирована отправка письма с DSN
- [ ] Проверено получение DSN уведомления
- [ ] Настроены правила фильтрации (опционально)
- [ ] Настроена периодическая проверка POP3 (каждые 60 минут)

## Заключение

После выполнения всех шагов ваш почтовый ящик Яндекс будет готов для работы с DSN уведомлениями. Система сможет:

1. Отправлять письма с запросом DSN
2. Получать уведомления о доставке через POP3
3. Парсить и обрабатывать статусы доставки
4. Сохранять результаты в базу данных

Важно помнить о лимитах Яндекс.Почты и использовать пароль приложения вместо основного пароля для безопасности.

