# Руководство по заполнению v_report_clob для типа 2 (CLOB)

## Обзор

Для создания вложения типа 2 необходимо заполнить переменную `v_report_clob` данными PDF в формате **Base64**. В скрипте `soap_aq_script_type2.sql` есть несколько способов это сделать.

## Что такое Base64?

Base64 - это способ кодирования бинарных данных (например, PDF файлов) в текстовый формат. Это необходимо, потому что:
- CLOB в Oracle хранит текстовые данные
- PDF файлы - это бинарные данные
- Base64 позволяет представить бинарные данные как текст

## Способы заполнения v_report_clob

### Способ 1: Чтение файла с диска (РЕКОМЕНДУЕТСЯ ДЛЯ ТЕСТИРОВАНИЯ)

**Когда использовать:** Когда у вас есть PDF файл на диске и вы хотите протестировать отправку.

**Шаги:**
1. Создайте директорию в Oracle:
   ```sql
   CREATE OR REPLACE DIRECTORY TEST_DIR AS 'C:\temp';
   -- Или для Linux: CREATE OR REPLACE DIRECTORY TEST_DIR AS '/tmp';
   ```

2. Положите тестовый PDF файл в эту директорию (например, `test.pdf`)

3. В скрипте `soap_aq_script_type2.sql` найдите блок "СПОСОБ 1" (строка ~114) и раскомментируйте его

4. Укажите имя директории и файла:
   ```sql
   v_file_path VARCHAR2(1000) := 'TEST_DIR';  -- Имя директории Oracle
   v_file_name VARCHAR2(1000) := 'test.pdf';   -- Имя вашего файла
   ```

5. Запустите скрипт

**Преимущества:**
- Работает с файлами любого размера
- Автоматически конвертирует в Base64
- Не требует ручного копирования данных

**Требования:**
- Права на чтение файлов через UTL_FILE
- Доступ к файловой системе сервера Oracle

---

### Способ 2: Использование BFILE

**Когда использовать:** Альтернатива способу 1, если у вас настроен BFILE.

**Шаги:**
1. Создайте директорию Oracle (как в способе 1)
2. Раскомментируйте блок "СПОСОБ 2" в скрипте
3. Укажите имя директории и файла
4. Запустите скрипт

---

### Способ 3: Прямая вставка Base64 строки

**Когда использовать:** Для маленьких файлов (до ~3000 символов Base64) или когда нужно быстро протестировать.

**Как получить Base64 из файла:**

**Windows PowerShell:**
```powershell
[Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\path\to\file.pdf"))
```

**Linux/Mac:**
```bash
base64 file.pdf | tr -d '\n'
```

**Онлайн:**
- https://www.base64encode.org/
- Загрузите файл, скопируйте результат

**Шаги:**
1. Получите Base64 строку из вашего PDF файла (используйте команды выше)
2. В скрипте найдите блок "СПОСОБ 3" и раскомментируйте его
3. Вставьте Base64 строку в переменную `v_base64_string`:
   ```sql
   v_base64_string := 'JVBERi0xLjQKJeLjz9MK...';  -- Ваша Base64 строка
   ```
4. Запустите скрипт

**Важно:** Base64 строка должна быть БЕЗ переносов строк!

**Ограничения:**
- Oracle имеет ограничение на длину строковых литералов (4000 символов)
- Для больших файлов используйте способ 1 или 2

---

### Способ 3А: Быстрый тест с минимальным PDF

**Когда использовать:** Для быстрой проверки работы скрипта без подготовки файлов.

**Шаги:**
1. В скрипте найдите блок "СПОСОБ 3А" (строка ~280) и раскомментируйте его
2. Запустите скрипт

**Что делает:**
- Создает минимальный валидный PDF файл прямо в коде
- Автоматически конвертирует его в Base64
- Не требует никаких файлов или дополнительных настроек

**Преимущества:**
- Самый быстрый способ для тестирования
- Не требует доступа к файловой системе
- Не требует подготовки файлов

---

### Способ 4: Получение из таблицы БД

**Когда использовать:** В продакшене, когда данные уже хранятся в БД.

**Шаги:**
1. Убедитесь, что данные PDF уже есть в таблице БД в формате Base64
2. Раскомментируйте блок "СПОСОБ 4" в скрипте
3. Адаптируйте запрос под вашу структуру БД:
   ```sql
   SELECT report_clob INTO v_report_clob
   FROM pcsystem.your_table_name
   WHERE your_id_column = v_parametr_value;
   ```
4. Запустите скрипт

---

## Рекомендации для тестирования

### Быстрый старт (5 минут):

1. **Используйте способ 3А** - раскомментируйте блок "СПОСОБ 3А" и запустите скрипт
2. Это создаст минимальный PDF и отправит его в очередь
3. Проверьте, что письмо отправлено

### Тестирование с реальным файлом:

1. **Используйте способ 1** или **способ 3**
2. Для способа 1: создайте директорию Oracle и положите PDF файл
3. Для способа 3: получите Base64 из файла через PowerShell/командную строку
4. Запустите скрипт

---

## Примеры команд для получения Base64

### Windows PowerShell:
```powershell
# Для одного файла
[Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\temp\test.pdf"))

# Сохранить в файл
[Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\temp\test.pdf")) | Out-File -Encoding ASCII "C:\temp\base64.txt"
```

### Linux/Mac:
```bash
# Для одного файла (без переносов строк)
base64 file.pdf | tr -d '\n'

# Сохранить в файл
base64 file.pdf | tr -d '\n' > base64.txt
```

### Python:
```python
import base64

with open("file.pdf", "rb") as f:
    base64_string = base64.b64encode(f.read()).decode('utf-8')
    print(base64_string)
```

---

## Проверка результата

После заполнения `v_report_clob` скрипт выведет:
```
✓ CLOB заполнен, размер: XXXX символов
```

Если вы видите ошибку:
```
✗ ОШИБКА: v_report_clob не заполнен!
```

Это означает, что ни один из способов не был раскомментирован или произошла ошибка при чтении данных.

---

## Частые проблемы

### Проблема: "ORA-29280: invalid directory path"
**Решение:** Убедитесь, что директория Oracle создана и путь указан правильно:
```sql
SELECT * FROM ALL_DIRECTORIES WHERE DIRECTORY_NAME = 'TEST_DIR';
```

### Проблема: "ORA-29282: invalid file operation"
**Решение:** Проверьте права доступа к файлу и директории. Убедитесь, что Oracle процесс имеет права на чтение файла.

### Проблема: Base64 строка слишком длинная
**Решение:** Используйте способ 1 или 2 для больших файлов, они работают с файлами любого размера.

### Проблема: PDF файл поврежден после отправки
**Решение:** Убедитесь, что Base64 строка не содержит переносов строк и пробелов. Используйте `tr -d '\n'` в Linux или удалите переносы вручную.

---

## Дополнительная информация

- Base64 увеличивает размер данных примерно на 33%
- PDF файл размером 1 МБ будет ~1.33 МБ в Base64
- CLOB в Oracle может хранить до 4 ГБ данных
- Для очень больших файлов (>100 МБ) рекомендуется использовать способ 1 или 2
