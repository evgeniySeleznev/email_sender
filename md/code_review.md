# –ö–æ–¥-—Ä–µ–≤—å—é: –ü—Ä–æ–±–ª–µ–º—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –º—å—é—Ç–µ–∫—Å–æ–≤

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–£—Ç–µ—á–∫–∞ –≥–æ—Ä—É—Ç–∏–Ω –≤ SMTP (email/smtp.go:290-398)**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –º–µ—Ç–æ–¥–µ `sendWithTLS` —Å–æ–∑–¥–∞–µ—Ç—Å—è –≥–æ—Ä —É—Ç–∏–Ω–∞ –±–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ cancel –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

```go
func (c *SMTPClient) sendWithTLS(ctx context.Context, ...) error {
    done := make(chan error, 1)
    go func() {
        // ... –¥–æ–ª–≥–∞—è —Ä–∞–±–æ—Ç–∞ —Å SMTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
        // –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ ctx.Done()!
    }()
    
    select {
    case <-ctx.Done():
        return ctx.Err()  // ‚Üê –≤—ã—Ö–æ–¥–∏–º, –Ω–æ –≥–æ—Ä—É—Ç–∏–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!
    case err := <-done:
        return err
    }
}
```

**–†–∏—Å–∫:** –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–º–µ–Ω–µ–Ω (graceful shutdown), –≥–æ—Ä—É—Ç–∏–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è "–≤–∏—Å–µ—Ç—å" —Å –æ—Ç–∫—Ä—ã—Ç—ã–º SMTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥ (—Ç–∞–π–º–∞—É—Ç Dial).

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä—å –≥–æ—Ä—É—Ç–∏–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.

---

### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ –Ω–∞ smtp.Dial (email/smtp.go:317)**

**–ü—Ä–æ–±–ª–µ–º–∞:**
```go
client, err = smtp.Dial(addr)  // ‚Üê –ë–ï–ó —Ç–∞–π–º–∞—É—Ç–∞!
```

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `smtp.Dial` –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞–¥–æ–ª–≥–æ, –µ—Å–ª–∏ —Å–µ—Ç—å –º–µ–¥–ª–µ–Ω–Ω–∞—è.

**–†–∏—Å–∫:** –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `net.DialTimeout` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º SMTP-–∫–ª–∏–µ–Ω—Ç–∞.

---

### 3. **–î–≤–æ–π–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —á—Ç–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ (service/service.go:156-169)**

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã:
1. –ü–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º (—Å—Ç—Ä–æ–∫–∞ 134)
2. –ü–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∞ 163)

**–†–∏—Å–∫:** –ï—Å–ª–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ª–≥–æ–µ (10-15 —Å–µ–∫—É–Ω–¥), —ç—Ç–æ —É–¥–≤–∞–∏–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É (–¥–æ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ—Å—Ç–æ—è).

**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Å—Ç–∞–≤–∏—Ç—å –æ–¥–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º retry.

---

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ reconnect –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö SMTP**

**–ü—Ä–æ–±–ª–µ–º–∞:** SMTP-–∫–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (—Å—Ç—Ä–æ–∫–∞ 75), –Ω–æ –ù–ï –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ï—Å–ª–∏ SMTP-—Å–µ—Ä–≤–µ—Ä —Ä–∞–∑–æ—Ä–≤–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–∞ —Ç–æ–º –∂–µ —Å–ª–æ–º–∞–Ω–Ω–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (connection reset, EOF) –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å SMTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

---

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 5. **–ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race condition –≤ responseQueueWriter**

–í `service/service.go:719-752` –µ—Å—Ç—å `responseQueueWriter`, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å `responseQueue`. –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Ä—è–µ—Ç—Å—è (—Å—Ç—Ä–æ–∫–∞ 714):

```go
select {
case s.responseQueue <- params:
    // OK
default:
    logger.Log.Warn("–û—á–µ—Ä–µ–¥—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω")
    // ‚Üê —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Ç–µ—Ä—è–Ω!
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–¥–µ–ª–∞—Ç—å –æ—á–µ—Ä–µ–¥—å unbuffered –∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É.

---

### 6. **waitForActiveOperations –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞ 35 —Å–µ–∫—É–Ω–¥**

–í `db/oracle.go:187-222` –µ—Å—Ç—å `waitForActiveOperations` —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º 35 —Å–µ–∫—É–Ω–¥. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è Reconnect, –Ω–æ –ù–ï –¥–ª—è Hot Swap.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è Hot Swap –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç (5-10 —Å–µ–∫—É–Ω–¥), —Ç–∞–∫ –∫–∞–∫ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –±—ã—Å—Ç—Ä–æ.

---

## ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)

1. ‚úÖ Hot Swap –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è DB
2. ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ atomic —Å—á–µ—Ç—á–∏–∫
3. ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è SMTP –∏ –æ—á–µ—Ä–µ–¥–∏
4. ‚úÖ Context cancellation –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–∏–∫–ª–∞—Ö
5. ‚úÖ Graceful shutdown —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏

---

## –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É—Ç–µ—á–∫—É –≥–æ—Ä—É—Ç–∏–Ω –≤ SMTP
2. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ –≤—Å–µ —Å–µ—Ç–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
4. –°–¥–µ–ª–∞—Ç—å –±—É—Ñ–µ—Ä responseQueue –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º
