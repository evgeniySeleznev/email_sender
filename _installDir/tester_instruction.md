# Инструкция по тестированию Email Sender

Данный документ содержит подробные инструкции по тестированию функциональности приложения Email Sender.

## Предварительные требования

### 1. Подготовка окружения

1. **Запустите контейнер** согласно инструкции в `README.md`
2. **Убедитесь, что контейнер работает:**
   ```
   docker compose ps
   ```
3. **Проверьте логи на наличие ошибок:**
   ```
   tail -50 logs/app.log
   ```

### 2. Настройка тестового режима

Для тестирования рекомендуется включить режим Debug в `settings/settings.ini`:
```ini
[Mode]
Debug = True
```

В режиме Debug все письма будут отправляться на тестовый email адрес из базы данных, а не реальным получателям.

## Тестовые сценарии

### 1. Проверка подключения к Oracle БД

**Ожидаемый результат:**
При запуске в логах должно появиться сообщение:
```
Успешно подключено к Oracle базе данных
```

**Если подключение не удалось:**
1. Проверьте настройки подключения в `settings/settings.ini`
2. Убедитесь, что Oracle сервер доступен из сети контейнера
3. Проверьте правильность учетных данных

---

### 2. Проверка подключения к SMTP серверу

**Ожидаемый результат:**
При отправке первого письма в логах должно появиться сообщение об успешной отправке.

**Если отправка не удалась:**
1. Проверьте настройки SMTP в `settings/settings.ini`
2. Убедитесь, что SMTP сервер доступен
3. Проверьте правильность учетных данных и порта

---

### 3. Проверка отправки простого email

**Шаги:**
1. Добавьте тестовое сообщение в очередь Oracle AQ
2. Наблюдайте логи в реальном времени: `tail -f logs/app.log`
3. Проверьте, что письмо отправлено

**Ожидаемые сообщения в логах:**
```
Получено сообщение из очереди
Email успешно отправлен
```

---

### 4. Проверка отправки с вложением типа 1 (Crystal Reports)

**Шаги:**
1. Добавьте сообщение с вложением типа 1 в очередь
2. Наблюдайте логи: `tail -f logs/app.log`

**Ожидаемые сообщения:**
```
Обработка вложения
Вложение типа 1: Crystal Reports
Отчет успешно получен от Web Service
Email успешно отправлен
```

---

### 5. Проверка отправки с вложением типа 2 (CLOB из БД)

**Шаги:**
1. Добавьте сообщение с вложением типа 2 в очередь
2. Наблюдайте логи: `tail -f logs/app.log`

**Ожидаемые сообщения:**
```
Обработка вложения
Вложение типа 2: CLOB из БД
Данные успешно получены из БД
Email успешно отправлен
```

---

### 6. Проверка отправки с вложением типа 3 (файл из SMB/CIFS)

**Предварительно:**
- Убедитесь, что настроены параметры доступа к CIFS/SMB в секции `[share]`
- Файл должен существовать по указанному пути

**Шаги:**
1. Добавьте сообщение с вложением типа 3 в очередь
2. Наблюдайте логи: `tail -f logs/app.log`

**Ожидаемые сообщения:**
```
Обработка вложения
Вложение типа 3: файл
Файл успешно прочитан с SMB шары
Email успешно отправлен
```

---

### 7. Проверка IMAP bounce-сообщений

Если настроен IMAP, приложение проверяет bounce-сообщения через 30 секунд после отправки.

**Ожидаемые сообщения:**
```
Запланирована проверка статуса письма
Статус письма проверен
```

---

### 8. Проверка graceful shutdown

**Шаги:**
1. Отправьте сигнал завершения контейнеру: `docker compose stop`
2. Наблюдайте логи

**Ожидаемые сообщения:**
```
Получен сигнал, инициируется graceful shutdown
Все операции завершены
Graceful shutdown завершен успешно
```

---

### 9. Проверка переподключения к БД

**Шаги (для опытных тестировщиков):**
1. Временно отключите сеть к Oracle серверу (или остановите БД)
2. Наблюдайте логи: `tail -f logs/app.log`
3. Восстановите соединение
4. Проверьте, что приложение успешно переподключилось

**Ожидаемые сообщения:**
```
Ошибка проверки соединения с БД: ...
Попытка переподключения к БД...
Успешно переподключено к Oracle базе данных
```

---

### 10. Проверка работы по расписанию

Приложение работает только в указанное рабочее время (настройки `TimeStart` и `TimeEnd` в `settings/settings.ini`).

**Проверка:**
1. Установите рабочее время, например: `TimeStart=9:00`, `TimeEnd=21:00`
2. Перезапустите контейнер
3. Вне рабочего времени приложение должно ожидать начала рабочего дня
4. В рабочее время приложение должно обрабатывать сообщения

---

## Дополнительные проверки

### Проверка производительности

1. **Мониторинг использования ресурсов:**
   ```
   docker stats
   ```

2. **Проверка количества обработанных сообщений:**
   ```
   grep "Email успешно отправлен" logs/app.log | wc -l
   ```

### Проверка безопасности

1. Убедитесь, что пароли в `settings/settings.ini` не логируются
2. Проверьте права доступа к файлам настроек (должны быть 644)
3. Убедитесь, что логи не содержат чувствительной информации

---

## Типичные проблемы и решения

### Контейнер не запускается

1. Проверьте логи приложения: `tail -100 logs/app.log` (если файл существует) или проверьте статус контейнера: `docker compose ps`
2. Убедитесь, что файл настроек существует: `ls -la settings/settings.ini`
3. Проверьте права доступа: `chmod 644 settings/settings.ini`

### Сообщения не обрабатываются

1. Проверьте, что очередь не пуста в Oracle БД
2. Проверьте логи в файле `logs/app.log` на наличие ошибок обработки: `grep -i "ошибка\|error" logs/app.log`
3. Убедитесь, что consumer name правильный и имеет доступ к очереди
4. Проверьте, что приложение работает в рабочее время

### Email не отправляются

1. Проверьте настройки SMTP серверов
2. Убедитесь, что SMTP сервер доступен
3. Проверьте правильность учетных данных
4. Проверьте логи на наличие ошибок SMTP подключения: `grep -i "smtp.*ошибка\|smtp.*error" logs/app.log`

### Логи не записываются

1. Проверьте права доступа к папке `logs/`: `chmod 777 logs`
2. Убедитесь, что папка существует: `ls -la logs/`
3. Проверьте настройки логирования в `settings/settings.ini`

---

## Контакты и поддержка

При возникновении проблем:
1. Проверьте статус контейнера: `docker compose ps`
2. Проверьте логи приложения: `tail -100 logs/app.log`
3. Убедитесь, что все настройки корректны
4. Обратитесь к разделу "Устранение неполадок" в `README.md`
